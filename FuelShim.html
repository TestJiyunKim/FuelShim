<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>FUEL SHIM 계산</title>
  <style>
    /* 기존 CSS 유지 */
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
      background-color: #f4f4f9;
      color: #333;
      margin: 0;
      padding-bottom: 120px;
    }
    h2 {
      color: #444;
      margin-bottom: 8px;
      text-align: center;
    }
    .number-control {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 12px;
      padding: 0 10px;
      justify-content: center;
    }
    .number-control input {
      width: 50px;
      height: 18px;
      text-align: center;
      padding: 3px;
      border: 2px solid #007bff;
      border-radius: 4px;
      font-size: 13px;
      -webkit-appearance: none;
      -moz-appearance: textfield;
    }
    .number-control button {
      width: 40px !important;
      height: 30px !important;
      font-size: 18px !important;
      padding: 0 !important;
      border: 2px solid #007bff;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    .groups-container {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .group-wrapper {
      display: flex;
      gap: 2px;
      width: 100%;
      align-items: flex-start;
    }
    .input-group {
      display: flex;
      gap: 2px;
      padding: 7px 3px 8px;
      border: 2px solid #007bff;
      border-radius: 6px;
      background-color: white;
      position: relative;
      height: 438px;
      box-sizing: border-box;
      flex: 1;
    }
    .bed-label {
      position: absolute;
      top: -11px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 0 6px;
      font-weight: bold;
      color: #007bff;
      font-size: 13px;
    }
    .numbering {
      margin-top: 11px !important;
      width: 29px !important;
      height: 416px;
      padding: 3px;
      border: 1px solid #ccc;
      border-radius: 3px;
      background-color: #f0f0f0;
      font-size: 30px;
      line-height: 42px;
      text-align: right;
      overflow-y: hidden;
    }
    .input-numbers,
    .results {
      height: 416px;
      padding: 3px;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-size: 30px;
      line-height: 42px;
      flex-shrink: 0;
      box-sizing: border-box;
      min-width: 44px;
      min-height: 44px;
      touch-action: manipulation;
    }
    .input-numbers {
      width: 144px !important;
      resize: none;
      background-color: white;
      margin-top: 2px;
    }
    .results {
      width: 144px !important;
      background-color: #f0f0f0;
    }
    .negative {
      color: red !important;
    }
    .invalid {
      color: red !important;
      font-weight: bold;
    }
    .results div:empty {
      height: 42px;
      visibility: hidden;
    }
    #averageDisplay {
      margin-left: 10px;
      color: #007bff;
      font-weight: bold;
      font-size: 13px;
    }
    #revisionDisplay {
      position: absolute;
      top: 10px;
      right: 10px;
      color: #666;
      font-size: 12px;
    }
    .button-row {
      position: fixed;
      left: 10px;
      right: 10px;
      display: flex;
      gap: 8px;
      justify-content: center;
      padding: 0 10px;
    }
    #buttonRow1 {
      bottom: 60px;
    }
    #buttonRow2 {
      bottom: 10px;
    }
    .button-row button {
      flex: 1;
      min-width: 90px;
      max-width: 150px;
      padding: 10px 12px;
      border: none;
      border-radius: 25px;
      font-size: 13px;
      cursor: pointer;
      transition: transform 0.2s;
      white-space: nowrap;
    }
    .button-row button:hover {
      transform: translateY(-2px);
    }
    #resetButton { background-color: #dc3545; color: white; }
    #copyReportButton { background-color: #007bff; color: white; }
    #shareButton { background-color: #28a745; color: white; }
    #saveButton { background-color: #ffc107; color: black; }
    #loadButton { background-color: #17a2b8; color: white; }
    #resetButtonLandscape { background-color: #dc3545; color: white; }
    #copyReportButtonLandscape { background-color: #007bff; color: white; }
    #shareButtonLandscape { background-color: #28a745; color: white; }
    #saveButtonLandscape { background-color: #ffc107; color: black; }
    #loadButtonLandscape { background-color: #17a2b8; color: white; }
    #loadButton.disabled, #loadButtonLandscape.disabled {
      background-color: #999 !important;
      cursor: not-allowed;
      opacity: 0.7;
    }
    @media (orientation: landscape) {
      .groups-container {
        flex-direction: row !important;
        gap: 2px !important;
        margin: 0 10px;
      }
      .group-wrapper {
        width: auto !important;
        flex: 1;
        margin-right: 2px !important;
      }
      .group-wrapper:not(:first-child) .numbering {
        display: none !important;
      }
      .input-group {
        margin-right: 0 !important;
      }
      .input-numbers,
      .results {
        width: 82px !important;
      }
      .button-row {
        bottom: 5px !important;
        flex-wrap: nowrap !important;
        gap: 4px !important;
        padding: 0 10px;
      }
      #buttonRow1, #buttonRow2 {
        display: none !important;
      }
      #landscapeButtons {
        display: flex !important;
        width: calc(100% - 20px);
      }
    }
    @media (orientation: portrait) {
      #buttonRow1 button {
        padding: 8px 10px !important;
        font-size: 12px !important;
      }
    }
    #landscapeButtons {
      display: none;
    }
  </style>
</head>
<body>
  <div id="revisionDisplay"></div>
  <h2>FUEL SHIM 계산</h2>
  <div class="number-control">
    <button id="decrementTarget">-</button>
    <input type="number" id="targetNumber" value="144" pattern="[0-9]*" inputmode="numeric">
    <button id="incrementTarget">+</button>
    <span id="averageDisplay">평균: 0.0</span>
  </div>
  <div class="groups-container" id="bedContainer"></div>
  
  <div class="button-row" id="buttonRow1">
    <button id="resetButton">초기화</button>
    <button id="copyReportButton">보고서 생성</button>
  </div>
  <div class="button-row" id="buttonRow2">
    <button id="shareButton">데이터 공유</button>
    <button id="saveButton">데이터 저장</button>
    <button id="loadButton" class="disabled">데이터 불러오기</button>
  </div>
  <div class="button-row" id="landscapeButtons">
    <button id="resetButtonLandscape">초기화</button>
    <button id="copyReportButtonLandscape">보고서 생성</button>
    <button id="shareButtonLandscape">데이터 공유</button>
    <button id="saveButtonLandscape">데이터 저장</button>
    <button id="loadButtonLandscape" class="disabled">데이터 불러오기</button>
  </div>

<script>
(() => {
  // 상수 정의
  const VERSION = '28a';
  const MAX_LINES = 9;
  const STORAGE_KEY = 'fuelShimData';
  const BED_COUNT = 4;

  // 상태 관리
  const state = {
    target: 144,
    beds: Array(BED_COUNT).fill().map(() => []),
    averages: []
  };

  // DOM 요소 캐싱
  const dom = {
    revisionDisplay: document.getElementById('revisionDisplay'),
    targetInput: document.getElementById('targetNumber'),
    averageDisplay: document.getElementById('averageDisplay'),
    bedContainer: document.getElementById('bedContainer'),
    decrementTargetBtn: document.getElementById('decrementTarget'),
    incrementTargetBtn: document.getElementById('incrementTarget')
  };

  // 계산 로직
  const calculate = {
    shimValue(target, input) {
      if(input.length !== 3) return { type: 'error', value: '⚠' };
      const diff = target - parseInt(input);
      return {
        value: Math.abs(diff * 0.125) >= 0.1 ? (diff * 0.125).toFixed(1).replace(/\.0$/, '') : '',
        isNegative: diff < 0
      };
    },

    average() {
      const inputs = state.beds.flat()
        .filter(line => line.length === 3)
        .map(line => parseInt(line));
      
      const avg = inputs.length ? 
        (inputs.reduce((a,b) => a + b, 0) / inputs.length).toFixed(1) : '0.0';
      
      dom.averageDisplay.textContent = `평균: ${avg}`;
    }
  };

  // DOM 조작
  const render = {
    updateResults(inputElement) {
      const wrapper = inputElement.closest('.group-wrapper');
      const results = inputElement.value.split('\n')
        .map(line => calculate.shimValue(state.target, line));
      
      wrapper.querySelector('.results').innerHTML = results
        .map(r => `<div class="${r.isNegative ? 'negative' : ''}">${r.value}</div>`)
        .join('');
    },

    initBeds() {
      let bedHTML = '';
      for(let i = 1; i <= BED_COUNT; i++) {
        bedHTML += `
          <div class="group-wrapper">
            <div class="numbering">${Array.from({length: MAX_LINES}, (_, j) => `${j+1}.`).join('\n')}</div>
            <div class="input-group">
              <div class="bed-label">${i}번 베드</div>
              <textarea class="input-numbers"></textarea>
              <div class="results"></div>
            </div>
          </div>
        `;
      }
      dom.bedContainer.innerHTML = bedHTML;
    }
  };

  // 데이터 처리
  const data = {
    save() {
      const saveData = {
        target: state.target,
        beds: [...document.querySelectorAll('.input-numbers')].map(i => i.value)
      };
      
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(saveData));
        alert('데이터 저장 완료');
      } catch (e) {
        console.error('Storage error:', e);
        alert('저장 실패: 저장 공간 부족');
      }
    },

    load() {
      try {
        const savedData = JSON.parse(localStorage.getItem(STORAGE_KEY));
        if(!savedData) throw new Error('No data');
        
        state.target = savedData.target;
        dom.targetInput.value = savedData.target;
        
        document.querySelectorAll('.input-numbers').forEach((input, i) => {
          input.value = savedData.beds[i] || '';
          render.updateResults(input);
        });
        
        calculate.average();
      } catch (e) {
        console.error('Load error:', e);
        alert('불러올 데이터 없음');
      }
    },

    generateShareURL() {
      const params = new URLSearchParams();
      params.set('target', state.target);
      [...document.querySelectorAll('.input-numbers')].forEach((input, i) => {
        params.set(`bed${i+1}`, input.value.replace(/\n/g, ','));
      });
      return `${location.origin}${location.pathname}?${params}`;
    }
  };

  // 이벤트 핸들러
  const events = {
    init() {
      // 버튼 이벤트
      const bindButtons = (ids, handler) => ids.forEach(id => {
        document.getElementById(id).addEventListener('click', handler);
        document.getElementById(`${id}Landscape`)?.addEventListener('click', handler);
      });

      bindButtons(['resetButton'], this.resetAll);
      bindButtons(['copyReportButton'], this.copyReport);
      bindButtons(['shareButton'], this.shareData);
      bindButtons(['saveButton'], data.save);
      bindButtons(['loadButton'], data.load);

      // 입력 필드
      document.querySelectorAll('.input-numbers').forEach(input => {
        input.addEventListener('input', this.handleInput);
        input.addEventListener('keydown', e => e.key === 'Enter' && e.preventDefault());
      });

      // 타겟 조절
      dom.decrementTargetBtn.addEventListener('click', () => this.adjustTarget(-1));
      dom.incrementTargetBtn.addEventListener('click', () => this.adjustTarget(1));
    },

    handleInput(event) {
      const input = event.target;
      let values = input.value.replace(/[^\d\n]/g, '').split('\n')
        .map(line => line.slice(0, 3))
        .filter((line, idx, arr) => idx === arr.length - 1 || line.trim());
      
      if(values.length < MAX_LINES && 
         values[values.length-1].length === 3 &&
         values[values.length-1] !== state.target.toString().slice(0,2)) {
        values.push(state.target.toString().slice(0,2));
      }
      
      input.value = values.join('\n');
      render.updateResults(input);
      calculate.average();
    },

    adjustTarget(delta) {
      state.target = Math.max(1, state.target + delta);
      dom.targetInput.value = state.target;
      document.querySelectorAll('.input-numbers').forEach(input => 
        render.updateResults(input));
      calculate.average();
    },

    resetAll() {
      document.querySelectorAll('.input-numbers').forEach(input => {
        input.value = '';
        render.updateResults(input);
      });
      state.target = 144;
      dom.targetInput.value = 144;
      calculate.average();
      history.replaceState({}, '', location.pathname);
    },

    copyReport() {
      const report = [...document.querySelectorAll('.input-group')]
        .map((group, i) => {
          const lines = group.querySelector('.input-numbers').value.split('\n');
          const results = [...group.querySelectorAll('.results div')]
            .map(div => div.textContent.trim());
          
          return `베드 ${i+1}:\n${lines.map((l, j) => 
            `${String(j+1).padStart(2)} | ${l.padEnd(3)} | ${results[j] || ''}`
          ).join('\n')}`;
        }).join('\n\n');
      
      navigator.clipboard.writeText(`FUEL SHIM 보고서\n\n${report}`);
      alert('보고서 복사 완료');
    },

    shareData() {
      navigator.clipboard.writeText(data.generateShareURL());
      alert('공유 URL 복사 완료');
    }
  };

  // 초기화
  const init = () => {
    dom.revisionDisplay.textContent = `Rev: ${VERSION}`;
    render.initBeds();
    events.init();
    
    if(location.search) {
      const params = new URLSearchParams(location.search);
      state.target = parseInt(params.get('target')) || 144;
      dom.targetInput.value = state.target;
      
      params.forEach((val, key) => {
        const bedIndex = key.match(/bed(\d)/)?.[1];
        if(bedIndex) {
          const input = document.querySelector(`.input-numbers:nth-of-type(${bedIndex})`);
          if(input) input.value = val.replace(/,/g, '\n');
        }
      });
      
      document.querySelectorAll('.input-numbers').forEach(input => 
        render.updateResults(input));
    }
    
    calculate.average();
  };

  document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
