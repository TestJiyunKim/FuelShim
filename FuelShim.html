<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>FUEL SHIM 계산</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
      background-color: #f4f4f9;
      color: #333;
      margin: 0;
      padding-bottom: 120px;
    }
    h2 {
      color: #444;
      margin-bottom: 8px;
      text-align: center;
    }
    .number-control {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 12px;
      padding: 0 10px;
      justify-content: center;
    }
    .number-control input {
      width: 50px;
      height: 18px;
      text-align: center;
      padding: 3px;
      border: 2px solid #007bff;
      border-radius: 4px;
      font-size: 13px;
      -webkit-appearance: none;
      -moz-appearance: textfield;
    }
    .number-control button {
      width: 40px !important;
      height: 30px !important;
      font-size: 18px !important;
      padding: 0 !important;
      border: 2px solid #007bff;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    .groups-container {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .group-wrapper {
      display: flex;
      gap: 2px;
      width: 100%;
      align-items: flex-start;
    }
    .input-group {
      display: flex;
      gap: 2px;
      padding: 7px 3px 8px;
      border: 2px solid #007bff;
      border-radius: 6px;
      background-color: white;
      position: relative;
      height: 438px;
      box-sizing: border-box;
      flex: 1;
    }
    .bed-label {
      position: absolute;
      top: -11px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 0 6px;
      font-weight: bold;
      color: #007bff;
      font-size: 13px;
    }
    .numbering {
      margin-top: 11px !important;
      width: 29px !important;
      height: 416px;
      padding: 3px;
      border: 1px solid #ccc;
      border-radius: 3px;
      background-color: #f0f0f0;
      font-size: 30px;
      line-height: 42px;
      text-align: right;
      overflow-y: hidden;
    }
    .input-numbers,
    .results {
      height: 416px;
      padding: 3px;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-size: 30px;
      line-height: 42px;
      flex-shrink: 0;
      box-sizing: border-box;
      min-width: 44px;
      min-height: 44px;
      touch-action: manipulation;
    }
    .input-numbers {
      width: 144px !important;
      resize: none;
      background-color: white;
      margin-top: 2px;
    }
    .results {
      width: 144px !important;
      background-color: #f0f0f0;
    }
    .negative {
      color: red !important;
    }
    .invalid {
      color: red !important;
      font-weight: bold;
    }
    .results div:empty {
      height: 42px;
      visibility: hidden;
    }
    #averageDisplay {
      margin-left: 10px;
      color: #007bff;
      font-weight: bold;
      font-size: 13px;
    }
    #revisionDisplay {
      position: absolute;
      top: 10px;
      right: 10px;
      color: #666;
      font-size: 12px;
    }
    .button-row {
      position: fixed;
      left: 10px;
      right: 10px;
      display: flex;
      gap: 8px;
      justify-content: center;
      padding: 0 10px;
    }
    #buttonRow1 {
      bottom: 60px;
    }
    #buttonRow2 {
      bottom: 10px;
    }
    .button-row button {
      flex: 1;
      min-width: 90px;
      max-width: 150px;
      padding: 10px 12px;
      border: none;
      border-radius: 25px;
      font-size: 13px;
      cursor: pointer;
      transition: transform 0.2s;
      white-space: nowrap;
    }
    .button-row button:hover {
      transform: translateY(-2px);
    }
    #resetButton { background-color: #dc3545; color: white; }
    #copyReportButton { background-color: #007bff; color: white; }
    #shareButton { background-color: #28a745; color: white; }
    #saveButton { background-color: #ffc107; color: black; }
    #loadButton { background-color: #17a2b8; color: white; }
    #resetButtonLandscape { background-color: #dc3545; color: white; }
    #copyReportButtonLandscape { background-color: #007bff; color: white; }
    #shareButtonLandscape { background-color: #28a745; color: white; }
    #saveButtonLandscape { background-color: #ffc107; color: black; }
    #loadButtonLandscape { background-color: #17a2b8; color: white; }
    #loadButton.disabled, #loadButtonLandscape.disabled {
      background-color: #999 !important;
      cursor: not-allowed;
      opacity: 0.7;
    }
    @media (orientation: landscape) {
      .groups-container {
        flex-direction: row !important;
        gap: 2px !important;
        margin: 0 10px;
      }
      .group-wrapper {
        width: auto !important;
        flex: 1;
        margin-right: 2px !important;
      }
      .group-wrapper:not(:first-child) .numbering {
        display: none !important;
      }
      .input-group {
        margin-right: 0 !important;
      }
      .input-numbers,
      .results {
        width: 82px !important;
      }
      .button-row {
        bottom: 5px !important;
        flex-wrap: nowrap !important;
        gap: 4px !important;
        padding: 0 10px;
      }
      #buttonRow1, #buttonRow2 {
        display: none !important;
      }
      #landscapeButtons {
        display: flex !important;
        width: calc(100% - 20px);
      }
    }
    @media (orientation: portrait) {
      #buttonRow1 button {
        padding: 8px 10px !important;
        font-size: 12px !important;
      }
    }
    #landscapeButtons {
      display: none;
    }
    .type-selector {
      text-align: center;
      margin: 10px 0;
    }
    #typeSelect {
      padding: 8px 12px;
      border-radius: 20px;
      border: 2px solid #007bff;
      font-size: 14px;
      background-color: white;
      max-width: 280px;
      width: 90%;
    }
  </style>
</head>
<body>
  <div id="revisionDisplay"></div>
  <h2 id="mainTitle">FUEL SHIM 계산</h2>
  <!-- 타입 선택 드롭다운 추가 -->
  <div class="type-selector">
    <select id="typeSelect">
      <option value="0.4">22CDF (/2.5)</option>
      <option value="0.666">27DF (/1.5)</option>
      <option value="1.25">35DF (/0.8)</option>
      <option value="0.5">21/32 (/2)</option>
      <option value="0.5">25/33 (/2)</option>
      <option value="0.769">32/40 (/1.3)</option>
    </select>
  </div>
  <div class="number-control">
    <button id="decrementTarget" aria-label="목표값 감소">-</button>
    <input type="number" id="targetNumber" value="144" pattern="[0-9]*" inputmode="numeric">
    <button id="incrementTarget" aria-label="목표값 증가">+</button>
    <span id="averageDisplay">평균: 0.0</span>
  </div>
  <div class="groups-container" id="bedContainer"></div>
  
  <!-- 세로모드 버튼 -->
  <div class="button-row" id="buttonRow1">
    <button id="resetButton">초기화</button>
    <button id="copyReportButton">보고서 생성</button>
  </div>
  <div class="button-row" id="buttonRow2">
    <button id="shareButton">데이터 공유</button>
    <button id="saveButton">데이터 저장</button>
    <button id="loadButton" class="disabled">데이터 불러오기</button>
  </div>
  <!-- 가로모드 버튼 -->
  <div class="button-row" id="landscapeButtons">
    <button id="resetButtonLandscape">초기화</button>
    <button id="copyReportButtonLandscape">보고서 생성</button>
    <button id="shareButtonLandscape">데이터 공유</button>
    <button id="saveButtonLandscape">데이터 저장</button>
    <button id="loadButtonLandscape" class="disabled">데이터 불러오기</button>
  </div>
  
  <script>
    (() => {
      // 상수 및 기본 설정
      const revision = '26h';
      let initialPrefix = '14';
      const MAX_LINES = 9;
      const STORAGE_KEY = 'fuelShimData';
      const bedCount = 4;
      
      // DOM 요소 캐싱
      const revisionDisplay = document.getElementById('revisionDisplay');
      const targetInput = document.getElementById('targetNumber');
      const averageDisplay = document.getElementById('averageDisplay');
      const bedContainer = document.getElementById('bedContainer');
      const decrementTargetBtn = document.getElementById('decrementTarget');
      const incrementTargetBtn = document.getElementById('incrementTarget');
      const resetButtons = [document.getElementById('resetButton'), document.getElementById('resetButtonLandscape')];
      const copyReportButtons = [document.getElementById('copyReportButton'), document.getElementById('copyReportButtonLandscape')];
      const shareButtons = [document.getElementById('shareButton'), document.getElementById('shareButtonLandscape')];
      const saveButtons = [document.getElementById('saveButton'), document.getElementById('saveButtonLandscape')];
      const loadButtons = [document.getElementById('loadButton'), document.getElementById('loadButtonLandscape')];
      const typeSelect = document.getElementById('typeSelect');
      const mainTitle = document.getElementById('mainTitle');

      /**
       * 입력된 숫자들의 평균을 계산하여 업데이트합니다.
       */
      const updateAverage = () => {
        const inputs = Array.from(document.querySelectorAll('.input-numbers'))
          .flatMap(input => input.value.split('\n')
            .filter(line => line.length === 3)
            .map(line => parseInt(line)))
          .filter(num => !isNaN(num));
        const average = inputs.length > 0 ? (inputs.reduce((a, b) => a + b, 0) / inputs.length).toFixed(1) : '0.0';
        averageDisplay.textContent = `평균: ${average}`;
      };
      
      /**
       * 각 입력 창에 대해 결과를 계산하여 화면에 출력합니다.
       * @param {HTMLElement} inputElement - 계산 대상 입력창
       */
      const calculateResults = (inputElement) => {
        const wrapper = inputElement.closest('.group-wrapper');
        const target = parseInt(targetInput.value);
        const numbers = inputElement.value.split('\n');
        const selectedValue = parseFloat(typeSelect.value); // 선택된 타입 값 가져오기
        const typeName = typeSelect.options[typeSelect.selectedIndex].text.split(' ')[0]; // 타입 이름 가져오기

        const results = numbers.map((num, index) => {
          const isLastLine = index === numbers.length - 1;
          if (!isLastLine && num.length > 0 && num.length < 3 && /^\d+$/.test(num)) {
            return { value: '오류!', style: 'invalid', isNegative: false };
          }
          if (num.length !== 3) return { value: num.length > 0 ? '⚠' : '', isNegative: false };
          const n = parseInt(num);
          const diff = target - n;
          const result = Math.trunc(diff * selectedValue * 10) / 10; // 선택된 타입 값으로 계산
          return {
            value: Math.abs(result) >= 0.1 ? result.toFixed(1).replace(/\.0$/, '') : '',
            isNegative: result < 0
          };
        });
        const resultsContainer = wrapper.querySelector('.results');
        resultsContainer.innerHTML = results.map(r => {
          if (!r.value) return '<div></div>';
          const classes = [];
          if (r.style) classes.push(r.style);
          if (r.isNegative) classes.push('negative');
          return `<div class="${classes.join(' ')}">${r.value}</div>`;
        }).join('');

        // 제목 업데이트
        mainTitle.textContent = `${typeName} FUEL SHIM 계산`;
      };
      
      /**
       * 입력창 초기화 및 이벤트 등록 (접근성을 위해 aria-label 추가)
       * @param {HTMLTextAreaElement} inputElement
       */
      const initializeInput = (inputElement) => {
        inputElement.value = '';
        inputElement.addEventListener('focus', handleFirstFocus);
        inputElement.addEventListener('click', handleFirstFocus);
        inputElement.addEventListener('blur', handleBlur);
        inputElement.setAttribute('inputmode', 'numeric');
      };
      
      /**
       * 첫 포커스 시 초기 접두어 입력
       */
      const handleFirstFocus = (event) => {
        const input = event.target;
        if (input.value === '') {
          input.value = initialPrefix;
          input.setSelectionRange(initialPrefix.length, initialPrefix.length);
        }
      };
      
      /**
       * 포커스 아웃 시 접두어가 단독으로 남아 있으면 삭제 처리
       */
      const handleBlur = (event) => {
        const input = event.target;
        const lines = input.value.split('\n');
        if (lines[lines.length - 1] === initialPrefix) {
          lines.pop();
          input.value = lines.join('\n');
          calculateResults(input);
        }
      };
      
      /**
       * 목표값 조절 및 관련 입력창 업데이트
       * @param {number} delta - 변경 값
       */
      const adjustTargetNumber = (delta) => {
        let currentValue = parseInt(targetInput.value) || 144;
        const newValue = Math.max(1, currentValue + delta);
        targetInput.value = newValue;
        initialPrefix = newValue.toString().slice(0, 2);
        document.querySelectorAll('.input-numbers').forEach(input => calculateResults(input));
        updateAverage();
      };
      
      /**
       * 입력 이벤트 처리 (디바운스 고려 가능)
       */
      const handleInput = (event) => {
        const input = event.target;
        const isBackspace = event.inputType?.startsWith('delete') || event.key === 'Backspace';
        const cursorPos = input.selectionStart;
        const prevValue = input.value;
        const prevLines = prevValue.split('\n');
        let currentLine = 0;
        let posInLine = cursorPos;
        let accumulatedLength = 0;
        for (; currentLine < prevLines.length; currentLine++) {
          const lineLength = prevLines[currentLine].length + 1;
          if (cursorPos <= accumulatedLength + lineLength) {
            posInLine -= accumulatedLength;
            break;
          }
          accumulatedLength += lineLength;
        }
        
        let values = input.value.replace(/[^\d\n]/g, '').split('\n')
          .map(line => line.slice(0, 3))
          .filter((line, index, arr) => index === arr.length - 1 || line.trim() !== '')
          .slice(0, MAX_LINES);
          
        let dynamicPrefix = initialPrefix;
        if (values.length > 0 && values[values.length - 1].length === 3) {
          dynamicPrefix = values[values.length - 1].slice(0, 2);
        }
        
        let newLineAdded = false;
        if (!isBackspace && values.length < MAX_LINES && values[values.length - 1].length === 3 && values[values.length - 1] !== dynamicPrefix) {
          values.push(dynamicPrefix);
          newLineAdded = true;
        }
        
        const newValue = values.join('\n');
        if (newValue !== prevValue) {
          input.value = newValue;
          calculateResults(input);
          let newCursorPos;
          if (newLineAdded) {
            newCursorPos = newValue.length;
          } else {
            const newLines = newValue.split('\n');
            newCursorPos = 0;
            for (let i = 0; i < currentLine; i++) {
              newCursorPos += (newLines[i]?.length || 0) + 1;
            }
            newCursorPos += Math.min(posInLine, newLines[currentLine]?.length || 0);
          }
          requestAnimationFrame(() => {
            input.setSelectionRange(newCursorPos, newCursorPos);
          });
        } else {
          calculateResults(input);
        }
        updateAverage();
      };
      
      /**
       * 전체 초기화 (입력창 리셋, URL 파라미터 제거)
       */
      const resetAll = () => {
        typeSelect.value = '0.4'; // 기본 타입으로 초기화
        mainTitle.textContent = 'FUEL SHIM 계산';
        document.querySelectorAll('.input-numbers').forEach(input => {
          input.value = '';
          calculateResults(input);
        });
        window.history.replaceState({}, document.title, window.location.pathname);
        alert('초기화 완료');
      };
      
      /**
       * 보고서 생성: 각 베드의 입력값 및 계산 결과를 문자열로 반환
       */
      const generateReport = () => {
        const target = targetInput.value;
        const now = new Date();
        const kstTime = now.toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });
        let report = `[${typeSelect.options[typeSelect.selectedIndex].text}] FUEL SHIM 보고서\n\n목표값: ${target}\n생성일: ${kstTime}\n\n`;
        document.querySelectorAll('.input-group').forEach((group, idx) => {
          const input = group.querySelector('.input-numbers');
          const lines = input.value.split('\n')
            .map(line => line.padEnd(3, ' ').slice(0, 3))
            .filter(line => line.trim() !== '');
          if (lines.length === 0) return;
          const results = Array.from(group.querySelectorAll('.results div'))
            .map(div => div.textContent.trim())
            .slice(0, lines.length);
          report += `${idx + 1}번 베드\n순번  입력값  결과\n------------------------\n`;
          lines.forEach((v, i) => {
            const result = results[i] === '⚠' ? '오류!' : results[i];
            report += `${(i + 1).toString().padStart(2, ' ')}    ${v.padStart(3, '0')}    ${result}\n`;
          });
          report += '\n';
        });
        return report;
      };
      
      /**
       * 데이터 공유 URL 생성
       */
      const generateShareURL = () => {
        const params = new URLSearchParams();
        params.set('ver', 2); // 버전 정보 추가
        params.set('type', typeSelect.value); // 타입 정보 추가
        params.set('target', targetInput.value);
        document.querySelectorAll('.input-numbers').forEach((input, idx) => {
          const value = input.value.split('\n').join(',');
          params.set(`bed${idx + 1}`, value || '');
        });
        return `${window.location.href.split('?')[0]}?${params.toString()}`;
      };
      
      /**
       * 데이터 저장 (로컬 스토리지에 JSON 형식으로 저장)
       */
      const saveData = () => {
        const data = {
          version: 2, // 데이터 구조 버전
          date: new Date().getTime(),
          target: targetInput.value,
          type: typeSelect.value, // 타입 정보 추가
          beds: Array.from(document.querySelectorAll('.input-numbers')).map(input => input.value)
        };
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
          alert('데이터 저장 완료');
          updateLoadButton();
        } catch (error) {
          alert('데이터 저장 중 오류가 발생했습니다.');
          console.error(error);
        }
      };
      
      /**
       * 저장된 데이터를 로드하여 입력창 업데이트
       */
      const loadData = () => {
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (savedData) {
          try {
            const data = JSON.parse(savedData);
            if(data.version === 2) { // 새 데이터 구조 확인
              typeSelect.value = data.type || '0.4'; // 타입 정보 복원
              mainTitle.textContent = `${typeSelect.options[typeSelect.selectedIndex].text.split(' ')[0]} FUEL SHIM 계산`;
            }
            targetInput.value = data.target;
            initialPrefix = data.target.toString().slice(0, 2);
            document.querySelectorAll('.input-numbers').forEach((input, index) => {
              input.value = data.beds[index] || '';
              calculateResults(input);
            });
            updateAverage();
            alert('데이터 불러오기 완료');
          } catch (error) {
            alert('저장된 데이터를 불러오는 중 오류가 발생했습니다.');
            console.error(error);
          }
        } else {
          alert('저장된 데이터가 없습니다.');
        }
      };
      
      /**
       * URL 파라미터를 통해 데이터 로드
       */
      const loadDataFromURL = () => {
        const params = new URLSearchParams(window.location.search);
        if(params.get('type')) {
          typeSelect.value = params.get('type');
          mainTitle.textContent = `${typeSelect.options[typeSelect.selectedIndex].text.split(' ')[0]} FUEL SHIM 계산`;
        }
        const target = params.get('target');
        if (target) {
          targetInput.value = target;
          initialPrefix = target.slice(0, 2);
        }
        document.querySelectorAll('.input-numbers').forEach((input, index) => {
          const bedData = params.get(`bed${index + 1}`);
          if (bedData) {
            input.value = bedData.split(',').join('\n');
            calculateResults(input);
          } else {
            input.value = '';
            calculateResults(input);
          }
        });
        updateAverage();
      };
      
      /**
       * 로드 버튼의 텍스트 및 상태 업데이트
       */
      const updateLoadButton = () => {
        const savedData = localStorage.getItem(STORAGE_KEY);
        loadButtons.forEach(loadBtn => {
          if (savedData) {
            try {
              const data = JSON.parse(savedData);
              const saveDate = new Date(data.date);
              loadBtn.textContent = `${saveDate.getMonth() + 1}/${saveDate.getDate()} 불러오기`;
              loadBtn.classList.remove('disabled');
            } catch (error) {
              loadBtn.textContent = '데이터 불러오기';
              loadBtn.classList.add('disabled');
            }
          } else {
            loadBtn.textContent = '데이터 불러오기';
            loadBtn.classList.add('disabled');
          }
        });
      };
      
      /**
       * 베드(입력창) 생성
       */
      const initBeds = () => {
        let bedHTML = '';
        for (let i = 1; i <= bedCount; i++) {
          bedHTML += `
            <div class="group-wrapper">
              <div class="numbering">${Array.from({ length: MAX_LINES }, (_, j) => `${j + 1}.`).join('\n')}</div>
              <div class="input-group">
                <div class="bed-label">${i}번 베드</div>
                <textarea class="input-numbers"></textarea>
                <div class="results"></div>
              </div>
            </div>
          `;
        }
        bedContainer.innerHTML = bedHTML;
        document.querySelectorAll('.input-numbers').forEach(input => {
          initializeInput(input);
          input.addEventListener('input', handleInput);
          input.addEventListener('keydown', e => { if(e.key === 'Enter') e.preventDefault(); });
        });
      };
      
      /**
       * 초기화 함수: 초기값 설정, 베드 생성, 이벤트 등록, URL 파라미터 로드 등
       */
      const init = () => {
        revisionDisplay.textContent = `Rev: ${revision}`;
        targetInput.value = 144;
        initialPrefix = '14';
        initBeds();
        decrementTargetBtn.addEventListener('click', () => adjustTargetNumber(-1));
        incrementTargetBtn.addEventListener('click', () => adjustTargetNumber(1));
        resetButtons.forEach(btn => btn.addEventListener('click', resetAll));
        copyReportButtons.forEach(btn => btn.addEventListener('click', () => {
          navigator.clipboard.writeText(generateReport())
            .then(() => alert('보고서가 클립보드에 복사되었습니다.'))
            .catch(err => {
              alert('보고서 복사 중 오류가 발생했습니다.');
              console.error(err);
            });
        }));
        shareButtons.forEach(btn => btn.addEventListener('click', () => {
          navigator.clipboard.writeText(generateShareURL())
            .then(() => alert('공유 URL이 클립보드에 복사되었습니다.'))
            .catch(err => {
              alert('URL 복사 중 오류가 발생했습니다.');
              console.error(err);
            });
        }));
        saveButtons.forEach(btn => btn.addEventListener('click', saveData));
        loadButtons.forEach(btn => btn.addEventListener('click', function() {
          if (!this.classList.contains('disabled')) loadData();
        }));
        if (window.location.search) {
          loadDataFromURL();
        }
        updateLoadButton();
        updateAverage();

        // 드롭다운 변경 이벤트 리스너 추가
        typeSelect.addEventListener('change', () => {
          document.querySelectorAll('.input-numbers').forEach(input => {
            calculateResults(input); // 모든 입력창 재계산
            updateAverage(); // 평균값 업데이트
          });
          mainTitle.textContent = `${typeSelect.options[typeSelect.selectedIndex].text.split(' ')[0]} FUEL SHIM 계산`; // 제목 업데이트
        });
      };
      
      document.addEventListener('DOMContentLoaded', init);
    })();
  </script>
</body>
</html>