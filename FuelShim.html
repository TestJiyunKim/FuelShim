<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- Revision: 27s -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, minimum-scale=1.0, user-scalable=yes">
    <title>FUEL SHIM 계산</title>
    <style>
        /* CSS 초기화 */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: Arial, sans-serif;
            padding: 20px 10px 120px; /* 하단 버튼 공간 확보 */
            background-color: #f4f4f9;
            min-height: 100vh;
        }

        /* 헤더 영역 */
        .header {
            position: relative;
            margin-bottom: 20px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            font-size: 1.8rem;
            margin-bottom: 15px;
        }

        /* 숫자 입력 컨트롤 */
        .target-control {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 25px;
        }
        .target-control button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #3498db;
            background: white;
            font-size: 1.2rem;
            cursor: pointer;
        }
        .target-control input {
            width: 80px;
            height: 40px;
            text-align: center;
            font-size: 1.1rem;
            border: 2px solid #3498db;
            border-radius: 8px;
        }

        /* 베드 컨테이너 */
        .bed-container {
            display: grid;
            gap: 15px;
            max-width: 800px;
            margin: 0 auto;
        }

        /* 베드 그룹 */
        .bed-group {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .bed-header {
            font-weight: bold;
            color: #3498db;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        .input-wrapper {
            display: grid;
            grid-template-columns: 40px 1fr 1fr;
            gap: 10px;
        }
        .line-numbers {
            font-size: 1.2rem;
            color: #7f8c8d;
            text-align: right;
        }
        .input-area, .result-area {
            height: 300px;
            padding: 10px;
            border: 1px solid #bdc3c7;
            border-radius: 8px;
            font-size: 1.1rem;
            resize: none;
        }
        .result-area {
            background: #ecf0f1;
            overflow-y: auto;
        }

        /* 액션 버튼 */
        .action-buttons {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }
        .action-btn.primary {
            background: #3498db;
            color: white;
        }
        .action-btn.success {
            background: #2ecc71;
            color: white;
        }
        .action-btn:hover {
            transform: translateY(-2px);
        }

        /* 오류 메시지 */
        .error-toast {
            position: fixed;
            bottom: 80px;
            right: 20px;
            padding: 12px 24px;
            background: #e74c3c;
            color: white;
            border-radius: 25px;
            font-size: 0.9rem;
            display: none;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>FUEL SHIM 계산</h1>
        <div class="target-control">
            <button onclick="adjustTarget(-1)">-</button>
            <input type="number" id="targetValue" value="144">
            <button onclick="adjustTarget(1)">+</button>
        </div>
    </div>

    <div class="bed-container" id="bedContainer">
        <!-- 베드 그룹이 동적으로 생성됩니다 -->
    </div>

    <div class="action-buttons">
        <button class="action-btn success" id="shareBtn">📤 공유</button>
        <button class="action-btn primary" id="reportBtn">📄 보고서</button>
    </div>

    <div class="error-toast" id="errorToast"></div>

    <script>
        const revision = '27s';
        const MAX_LINES = 9;

        // 초기화 함수
        function initApp() {
            // 베드 그룹 생성
            const container = document.getElementById('bedContainer');
            for (let i = 1; i <= 4; i++) {
                container.innerHTML += `
                    <div class="bed-group">
                        <div class="bed-header">${i}번 베드</div>
                        <div class="input-wrapper">
                            <div class="line-numbers">${Array.from({length: MAX_LINES}, (_, i) => `${i+1}.`).join('<br>')}</div>
                            <textarea class="input-area" data-bed="${i}"></textarea>
                            <div class="result-area" data-results="${i}"></div>
                        </div>
                    </div>
                `;
            }

            // 이벤트 바인딩
            document.querySelectorAll('.input-area').forEach(input => {
                input.addEventListener('input', handleCalculation);
            });

            // URL 데이터 로드
            loadFromURL();
        }

        // 타겟 값 조정
        function adjustTarget(value) {
            const targetInput = document.getElementById('targetValue');
            targetInput.value = parseInt(targetInput.value) + value;
            updateCalculations();
        }

        // 계산 처리
        function handleCalculation(event) {
            const input = event.target;
            const bedNumber = input.getAttribute('data-bed');
            const results = document.querySelector(`[data-results="${bedNumber}"]`);
            const target = parseInt(document.getElementById('targetValue').value);

            const values = input.value.split('\n');
            const output = values.map(line => {
                if (line.length !== 3) return '';
                const diff = target - parseInt(line);
                return (diff * 0.125).toFixed(1);
            });

            results.innerHTML = output.map(val => `<div>${val}</div>`).join('');
        }

        // URL 데이터 로드
        function loadFromURL() {
            const params = new URLSearchParams(window.location.search);
            if (!params.has('target')) return;

            // 타겟 값 설정
            document.getElementById('targetValue').value = params.get('target');

            // 베드 데이터 로드
            Array.from(document.querySelectorAll('.input-area')).forEach((input, idx) => {
                const bedData = params.get(`bed${idx+1}`)?.split(',') || [];
                input.value = bedData.join('\n');
                handleCalculation({ target: input });
            });
        }

        // 공유 기능
        document.getElementById('shareBtn').addEventListener('click', () => {
            const target = document.getElementById('targetValue').value;
            const beds = Array.from(document.querySelectorAll('.input-area'))
                .map(input => input.value.split('\n').join(','));

            const params = new URLSearchParams({
                ver: revision,
                target: target,
                ...beds.reduce((acc, val, idx) => {
                    acc[`bed${idx+1}`] = val;
                    return acc;
                }, {})
            });

            const link = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
            navigator.clipboard.writeText(link)
                .then(() => alert('링크가 복사되었습니다!'))
                .catch(() => showError('링크 복사 실패'));
        });

        // 오류 메시지 표시
        function showError(message) {
            const toast = document.getElementById('errorToast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 5000);
        }

        // 앱 초기화
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>